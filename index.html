<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<title>Glass AI Chat</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
html,body{height:100%}

/* Glass */
.glass{
backdrop-filter: blur(20px);
background: rgba(255,255,255,0.6);
}

.dark .glass{
background: rgba(30,30,30,0.6);
}

/* Gradient background */
body{
background:
radial-gradient(circle at 20% 20%, rgba(99,102,241,.25), transparent 40%),
radial-gradient(circle at 80% 30%, rgba(236,72,153,.25), transparent 40%),
radial-gradient(circle at 50% 80%, rgba(16,185,129,.25), transparent 40%);
}
</style>

</head>

<body class="min-h-screen text-gray-800 dark:text-gray-100">

<!-- Loader -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-black z-50">
<div class="animate-pulse text-lg font-semibold">Loading App...</div>
</div>

<div class="min-h-screen flex">

<!-- Sidebar -->
<aside id="sidebar"
class="fixed md:relative w-72 h-full glass border-r border-white/30
transform -translate-x-full md:translate-x-0 transition flex flex-col z-40">

<div class="p-4 border-b border-white/30 flex justify-between">
<span class="font-semibold">Chats</span>
<button id="newChatBtn" class="px-2 py-1 bg-indigo-500 text-white rounded text-sm">New</button>
</div>

<div id="chatList" class="flex-1 overflow-y-auto"></div>

<div class="p-3 border-t border-white/30 flex gap-2">
<button id="settingsBtn" class="flex-1 border rounded text-xs">Settings</button>
<button id="themeBtn" class="flex-1 border rounded text-xs">Theme</button>
</div>

</aside>

<!-- Main -->
<main class="flex-1 flex flex-col min-h-screen">

<!-- Top -->
<div class="p-3 flex gap-2 items-center glass border-b border-white/30">
<button id="menuBtn" class="md:hidden border px-2 rounded">☰</button>
<div id="chatTitle" class="font-semibold">Chat</div>
</div>

<!-- Messages -->
<div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 pb-40"></div>

<!-- Input -->
<div class="sticky bottom-0 p-3"
style="padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));">

<div class="glass rounded-2xl shadow-lg flex gap-2 p-2">

<textarea id="input"
class="flex-1 bg-transparent outline-none resize-none p-2"
rows="1"
placeholder="Ask anything..."></textarea>

<button id="sendBtn"
class="px-4 py-2 bg-indigo-500 text-white rounded-xl">
Send
</button>

</div>
</div>

</main>
</div>

<!-- Settings -->
<div id="settingsModal"
class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">

<div class="glass p-4 rounded-xl w-[90%] max-w-md space-y-3">

<h2 class="font-semibold">Settings</h2>

<input id="apiKey" type="password" placeholder="OpenRouter API Key"
class="w-full border rounded p-2 bg-transparent">

<input id="model" type="text" placeholder="Model"
class="w-full border rounded p-2 bg-transparent">

<textarea id="systemPrompt" placeholder="System Prompt"
class="w-full border rounded p-2 bg-transparent"></textarea>

<div class="flex justify-end gap-2">
<button id="closeSettings" class="border px-3 py-1 rounded">Cancel</button>
<button id="saveSettings" class="bg-indigo-500 text-white px-3 py-1 rounded">Save</button>
</div>

</div>
</div>

<script>
(function(){

function $(id){ return document.getElementById(id) }
function json(v,d){ try{return JSON.parse(v)}catch{return d} }
function uid(){ return Date.now()+Math.random().toString(16).slice(2) }

/* STATE */
let chats = json(localStorage.getItem("chats"),[])
let currentId = localStorage.getItem("currentId")

let settings = json(localStorage.getItem("settings"),{
apiKey:"",
model:"deepseek/deepseek-chat:free",
systemPrompt:""
})

/* DOM */
const loading = $("loading")
const chatList = $("chatList")
const messagesDiv = $("messages")
const input = $("input")
const sendBtn = $("sendBtn")
const titleEl = $("chatTitle")
const sidebar = $("sidebar")

/* THEME */
function applyTheme(){
const t = localStorage.getItem("theme")||"light"
if(t==="dark") document.documentElement.classList.add("dark")
else document.documentElement.classList.remove("dark")
}
applyTheme()

$("themeBtn").onclick=()=>{
const d=document.documentElement.classList.contains("dark")
localStorage.setItem("theme",d?"light":"dark")
applyTheme()
}

/* CHAT */
function save(){
localStorage.setItem("chats",JSON.stringify(chats))
localStorage.setItem("currentId",currentId)
}

function createChat(){
const c={
id:uid(),
title:"New Chat",
messages:[],
systemPrompt:settings.systemPrompt||""
}
chats.unshift(c)
currentId=c.id
save()
render()
}

function current(){
return chats.find(c=>c.id===currentId)
}

/* RENDER */
function renderChats(){
chatList.innerHTML=""
chats.forEach(c=>{
const div=document.createElement("div")
div.className="p-3 border-b border-white/20 cursor-pointer"
div.textContent=c.title

div.onclick=()=>{
currentId=c.id
save()
render()
}

chatList.appendChild(div)
})
}

function md(text){
if(window.marked) return marked.parse(text||"")
return text
}

function renderMessages(){
const c=current()
if(!c){ messagesDiv.innerHTML=""; return }

titleEl.textContent=c.title
messagesDiv.innerHTML=""

c.messages.forEach(m=>{
const wrap=document.createElement("div")
wrap.className="flex "+(m.role==="user"?"justify-end":"justify-start")

const bubble=document.createElement("div")
bubble.className="max-w-[80%] p-3 rounded-2xl shadow "+
(m.role==="user"
? "bg-indigo-500 text-white"
: "glass border border-white/30")

bubble.innerHTML=md(m.content)

wrap.appendChild(bubble)
messagesDiv.appendChild(wrap)
})

messagesDiv.scrollTop=messagesDiv.scrollHeight
}

function render(){
renderChats()
renderMessages()
}

/* STREAM */
async function send(){

const text=input.value.trim()
if(!text) return

const c=current()
if(!c) return

input.value=""

const userMsg={role:"user",content:text}
const aiMsg={role:"assistant",content:""}

c.messages.push(userMsg)
c.messages.push(aiMsg)

render()

if(!settings.apiKey){
alert("Add API key in settings")
return
}

try{

const res=await fetch("https://openrouter.ai/api/v1/chat/completions",{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":"Bearer "+settings.apiKey,
"HTTP-Referer": window.location.href,
"X-Title": "Glass AI Chat"
},
body:JSON.stringify({
model:settings.model,
stream:true,
messages:[
...(c.systemPrompt?[{role:"system",content:c.systemPrompt}]:[]),
...c.messages
]
})
})

if(!res.ok){
const err=await res.text()
throw new Error(err)
}

const reader=res.body.getReader()
const decoder=new TextDecoder()

while(true){

const {done,value}=await reader.read()
if(done) break

const chunk=decoder.decode(value)
const lines=chunk.split("\n")

for(const line of lines){

if(!line.startsWith("data:")) continue

const data=line.replace("data:","").trim()
if(data==="[DONE]") break

try{
const json=JSON.parse(data)
const token=json.choices?.[0]?.delta?.content
if(token){
aiMsg.content+=token
renderMessages()
}
}catch{}
}
}

}catch(e){
aiMsg.content+="\n\n⚠ "+e.message
}

save()
render()
}

/* EVENTS */
sendBtn.onclick=send

input.addEventListener("keydown",e=>{
if(e.key==="Enter"&&!e.shiftKey){
e.preventDefault()
send()
}
})

$("newChatBtn").onclick=createChat

$("menuBtn").onclick=()=>{
sidebar.classList.toggle("-translate-x-full")
}

/* SETTINGS */
$("settingsBtn").onclick=()=>{
$("apiKey").value=settings.apiKey||""
$("model").value=settings.model||""
$("systemPrompt").value=settings.systemPrompt||""
$("settingsModal").classList.remove("hidden")
$("settingsModal").classList.add("flex")
}

$("closeSettings").onclick=()=>{
$("settingsModal").classList.add("hidden")
}

$("saveSettings").onclick=()=>{
settings.apiKey=$("apiKey").value.trim()
settings.model=$("model").value.trim()
settings.systemPrompt=$("systemPrompt").value.trim()

localStorage.setItem("settings",JSON.stringify(settings))
$("settingsModal").classList.add("hidden")
}

/* INIT */
function init(){
try{
if(!chats.length) createChat()
else render()
}catch(e){
console.error(e)
}
loading.style.display="none"
}

setTimeout(()=>{ loading.style.display="none" },2000)
init()

})()
</script>

</body>
</html>
